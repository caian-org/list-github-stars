name: run-test

inputs:
  sha:
    required: true
    type: string

  os:
    required: true
    type: string

  github-token:
    required: true
    type: string


runs:
  using: composite
  steps:
    - name: Download compiled artifact
      uses: dawidd6/action-download-artifact@v2
      with:
        name: artifact-${{ inputs.sha }}-${{ inputs.os }}
        workflow: build-many.yml

    - name: Install GitHub CLI
      run: |
        if [ "${{ inputs.os }}" = "Linux" ]; then
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
            | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg

          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
            | tee /etc/apt/sources.list.d/github-cli.list > /dev/null

          apt update
          apt install gh
        fi

        if [ "${{ inputs.os }}" = "macOS" ]; then
          gem install bundler
          brew install gh
        fi

        if [ "${{ inputs.os }}" = "Windows" ]; then
          choco install gh
        fi

    - name: Run and update
      run: |
        mv artifact-${{ inputs.sha }}-${{ inputs.os }} list-github-stars
        chmod +x list-github-stars

        ./list-github-start >> my-github-stars.md
        gh gist edit ada2117bd8c73a1e94e49580fd5c7cf7 --add my-github-stars.md
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
